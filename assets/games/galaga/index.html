
<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8" />

    <script async src="galaga.js"> </script>
    
    <script>
        var galaga;
        var canvas;
        var context;
        var imageData;
        var audio = {};

        var BUFFER_COUNT = 8;
        var BUFFER_SIZE = 1024; // samples
        var _writePos = 0;
        var _lastWritten;
        var _lastPlayed;
        var _totExecutionTime = .0;
        var _totEmulatedTime = .0;
        var _started = false;

        var Module = Module || {
            wasmBinaryFile: 'galaga.wasm',

            setStatus: function(text) {
                if (text == "" && !_started) {
                    _started = true;
                    start();
                }
            }       
        }

        function start() {
            canvas = document.getElementById("myGLCanvas");
            context = canvas.getContext("2d");
            context.scale(2.0, 2.0);
            imageData = context.createImageData(224, 288);

            document.addEventListener("keydown", onKeyDown);
            document.addEventListener("keyup", onKeyUp);

            galaga = new Module.GalagaMachine();

            initAudio();
            audio.dummySource.start();

            repeatOften();
        }

        function initAudio() {
            audio.freq = 48000;
            audio.channels = 1;
            audio.samples = BUFFER_COUNT * BUFFER_SIZE;
            audio.buffer = new Int16Array(audio.samples);

            window.AudioContext = window.AudioContext||window.webkitAudioContext;
            if (!window.AudioContext) {
                throw 'Web Audio API is not available!';
            }
            audio.context = new window.AudioContext;
            //console.log('Web Audio context playback frequency is ' + audio.context.sampleRate + ', desired playback frequency is ' + audio.freq);

            audio.dummySource = audio.context.createBufferSource();
            audio.dummySource.buffer = audio.context.createBuffer(audio.channels, 1.0, audio.freq);
            audio.dummySource.playbackRate.value = audio.freq / audio.context.sampleRate;

            audio.scriptNode = audio.context.createScriptProcessor(BUFFER_SIZE, 1, 1);

            audio.dummySource.connect(audio.scriptNode);
            audio.dummySource.loop = true;
            audio.scriptNode.connect(audio.context.destination);

            _lastPlayed = _lastWritten = (BUFFER_COUNT - 1);

            audio.scriptNode.onaudioprocess = function (audioEvent) {
                try {
                    var channelData = audioEvent.outputBuffer.getChannelData(0);
                    _lastPlayed = (_lastPlayed + 1) % BUFFER_COUNT;

                    var j = _lastPlayed * BUFFER_SIZE;
                    for (var i = 0; i < BUFFER_SIZE; i++, j++) {
                        // Convert from [-32768:32767] to [-1.0:1.0]
                        channelData[i] = audio.buffer[j] / 0x8000;
                        audio.buffer[j] = 0;
                    }
                }
                catch (e) {
                    console.log('Web Audio API error playing back audio: ' + e.toString());
                }
            }
        }

        var prevTimestamp;
        function repeatOften(timestamp) {
            var interval;
            if (!prevTimestamp || !timestamp) {
                interval = 20.0;
            }
            else {
                interval = timestamp - prevTimestamp;
            }
            prevTimestamp = timestamp;
            step(interval);
            requestAnimationFrame(repeatOften);
        }

        function step(interval) {
            if (interval > 67) {
                interval = 67;
            }

            var tStart = performance.now();

            galaga.Run(interval,
                function (video, audioBuffer) {
                    var tEnd = performance.now();
                    //console.log('run ' + interval + 'ms in actual ' + (t1 - t0) + 'ms');

                    _totExecutionTime += (tEnd - tStart);
                    _totEmulatedTime += interval;

                    // if (_totEmulatedTime >= 100000)
                    // {
                    //     alert('t: ' + _totExecutionTime + ' ' + _totEmulatedTime);
                    // }

                    // Video is a Uint8Array that aliases directly into the Emscripten heap
                    imageData.data.set(video);
                    context.putImageData(imageData, 0, 0, 0, 0, 224, 288);
                    context.drawImage(canvas, 0, 0);

                    // HTML5 audio is... complicated. Emitting samples with ... is not reliable,
                    // so we are use a ScriptProcessorNode that invokes periodically a callback
                    // (onaudioprocess) to request the next samples to play.
                    // Problem: ScriptProcessorNode works at a fixed sampling rate, which depends
                    // on the audio hardware. This is 44.1KHz most often, but sometimes 48KHz (like
                    // with a Microsoft Surface Pro 3). The Galaga emulator generates audio samples
                    // at 48KHz, so when we run at 44.1KHz we need to resample (by using a very rough
                    // algorithm, that just discards 13 out of 160 samples, no interpolation).

                    if (audio.context.sampleRate == 44100)
                    {
                        // Resample to 44.1KHz
                        var max = BUFFER_SIZE * _lastPlayed;
                        var q = 147.0 / 160.0;
                        var s = .0;
                        var i = 0;
                        var j = _writePos;
                        var len = BUFFER_SIZE * BUFFER_COUNT;
                        while (i < audioBuffer.length) {
                            if ((i % 960) == 0) {
                                s = .0;
                            }
                            s += q;
                            j = (_writePos + Math.floor(s)) % len;
                            if (j == max) {
                                break;
                            }
                            audio.buffer[j] = audioBuffer[i];
                            i++;
                        }
                        _writePos = j;
                    }
                    else // assume 48KHz
                    {
                        var max = BUFFER_SIZE * _lastPlayed;
                        var i = 0;
                        var j = _writePos;
                        var len = BUFFER_SIZE * BUFFER_COUNT;
                        while (i < audioBuffer.length) {
                            if (j == max) {
                                break;
                            }
                            audio.buffer[j] = audioBuffer[i];
                            i++;
                            j = (j + 1) % len;
                        }
                        _writePos = j;
                    }
                });
        }

        function onKeyDown(event) {
            var key = event.keyCode || event.which;
            switch (key) {
                case 48: //"0"
                    galaga.set_InsertCoin(true);
                    break;

                case 49: //"1"
                    galaga.set_Start1Player(true);
                    break;

                case 50: //"2"
                    galaga.set_Start2Player(true);
                    break;

                case 37: //"Left"
                    galaga.set_MoveLeft(true);
                    break;

                    case 37: //"A"
                    galaga.set_MoveLeft(true);
                    break;

                case 39: //"Right"
                    galaga.set_MoveRight(true);
                    break;

                    case 39: //"D"
                    galaga.set_MoveRight(true);
                    break;

                case 17: //"Control"
                    galaga.set_Button1(true);
                    break;

                default:
                    break;
            }
        }

        function onKeyUp(event) {
            var key = event.keyCode || event.which;
            switch (key) {
                case 48: //"0"
                    galaga.set_InsertCoin(true);
                    break;

                case 49: //"1"
                    galaga.set_Start1Player(true);
                    break;

                case 50: //"2"
                    galaga.set_Start2Player(true);
                    break;

                case 37: //"Left"
                    galaga.set_MoveLeft(true);
                    break;

                    case 37: //"A"
                    galaga.set_MoveLeft(true);
                    break;

                case 39: //"Right"
                    galaga.set_MoveRight(true);
                    break;

                    case 39: //"D"
                    galaga.set_MoveRight(true);
                    break;

                case 17: //"Control"
                    galaga.set_Button1(true);
                    break;

                default:
                    break;
            }
        }
    </script>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  
    ga('create', 'UA-29328129-2', 'auto');
    ga('send', 'pageview');
  </script>    
</head>
<body style="background:black;" onload=" main();">
    <table>
        <tr>
            <td>
                <canvas id="myGLCanvas" width="448" height="576"></canvas>
            </td>
            <td style="padding:12px 0px 0px 120px;" valign="top">
                <span style="text-align:center; color:white; font-family:'Segoe UI'; font-size:10pt">
                    <span style="font-size:11pt; color:white;"><strong>Galaga</strong></span>
                    <br />
                    <br />
                    <br />
                    <strong>Instructions:</strong>
                    <br />
                    After the machine boot completes:
                    <br />
                    Press <strong>1</strong> to start a one player game
                    <br />
                    Press <strong>2</strong> to start a two players game
                    <br />
                    (Works with Mozilla Firefox, Microsoft Edge and Google Chrome).
                    <br />
                    <br />
                    <strong>Controls:</strong>
                    <br />
                    <strong>Left</strong>-<strong>Right</strong> arrow keys to move left-right,
                    <br />
                    <strong>Ctrl</strong> key to shoot.
                </span>
            </td>
        </tr>
    </table>
</body>
</html>